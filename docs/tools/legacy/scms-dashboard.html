<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCMS Real Cost Tracking Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
        }
        
        .metric-card.savings {
            border-left-color: #27ae60;
        }
        
        .metric-card.efficiency {
            border-left-color: #f39c12;
        }
        
        .metric-card.patterns {
            border-left-color: #9b59b6;
        }
        
        .metric-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-subtitle {
            color: #95a5a6;
            font-size: 14px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .session-status {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active {
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        .status-inactive {
            background: #95a5a6;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .comparison-chart {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .chart-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .bar-chart {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 20px;
            margin: 20px 0;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #3498db, #5dade2);
            border-radius: 4px 4px 0 0;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-weight: bold;
            padding: 10px;
            min-height: 40px;
        }
        
        .bar.scms {
            background: linear-gradient(to top, #27ae60, #58d68d);
        }
        
        .pattern-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .pattern-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .pattern-item:last-child {
            border-bottom: none;
        }
        
        .pattern-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .pattern-stats {
            display: flex;
            gap: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .export-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #ecf0f1;
        }
        
        .validation-badge {
            display: inline-block;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 10px;
        }
        
        .usage-guide {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .usage-guide h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .usage-guide h3 {
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .usage-guide ol {
            margin-left: 20px;
            margin-bottom: 20px;
        }
        
        .usage-guide li {
            margin-bottom: 10px;
            color: #34495e;
            line-height: 1.6;
        }
        
        .usage-guide strong {
            color: #2c3e50;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .critical-box {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #fff;
        }
        
        .critical-box h3 {
            color: white;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .critical-box p {
            margin: 10px 0;
            line-height: 1.6;
        }
        
        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* Enhanced Economic Metrics Section */
        .enhanced-metrics {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .enhanced-metrics h2 {
            color: white;
            text-align: center;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .enhanced-metrics .subtitle {
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        
        .economic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .economic-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .economic-card .metric-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .economic-card .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .economic-card .metric-subtitle {
            color: #95a5a6;
            font-size: 13px;
            margin-bottom: 10px;
        }
        
        /* Economic Signature Badges */
        .signature-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        
        .signature-exponential {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .signature-compound {
            background: linear-gradient(135deg, #2ecc71, #58d68d);
            color: white;
        }
        
        .signature-initial {
            background: linear-gradient(135deg, #3498db, #5dade2);
            color: white;
        }
        
        .signature-early {
            background: linear-gradient(135deg, #f39c12, #f8b739);
            color: white;
        }
        
        .signature-baseline-plus {
            background: linear-gradient(135deg, #e67e22, #f39c12);
            color: white;
        }
        
        .signature-baseline {
            background: linear-gradient(135deg, #95a5a6, #bdc3c7);
            color: white;
        }
        
        /* Tab System */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 15px 30px;
            border: none;
            background: transparent;
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
            bottom: -2px;
        }
        
        .tab-btn:hover {
            color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .tab-btn.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* System Health Styles */
        .health-overview {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .health-status-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .health-icon {
            font-size: 3em;
        }
        
        .health-title {
            flex: 1;
        }
        
        .health-title h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .health-subtitle {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .health-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .health-metric {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .health-metric.green {
            border-left-color: #27ae60;
        }
        
        .health-metric.yellow {
            border-left-color: #f39c12;
        }
        
        .health-metric.orange {
            border-left-color: #e67e22;
        }
        
        .health-metric.red {
            border-left-color: #e74c3c;
        }
        
        .health-metric-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .health-metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }
        
        .health-metric-value.green {
            color: #27ae60;
        }
        
        .health-metric-value.yellow {
            color: #f39c12;
        }
        
        .health-metric-details {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .health-metric-trend {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 4px;
            font-size: 0.85em;
            margin-top: 8px;
        }
        
        .health-metric-trend.improving {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        
        .health-metric-trend.degrading {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        
        .recommendations-panel {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .recommendations-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recommendation-icon {
            font-size: 1.5em;
        }
        
        .warning-panel {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .warning-panel h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        /* Copy Button Styles */
        .prompt-container {
            position: relative;
            margin: 15px 0;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .copy-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .copy-btn:active {
            transform: translateY(0);
        }
        
        .copy-btn.copied {
            background: #27ae60;
        }
        
        .copy-btn.copied::after {
            content: ' ‚úì';
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>SCMS Real Cost Tracking <span class="validation-badge">Algorithmic Validation</span></h1>
            <p class="subtitle">Empirical measurement of economic benefits through actual token consumption</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-success" onclick="startSCMSSession()">Start SCMS Session</button>
            <button class="btn btn-warning" onclick="startBaselineSession()">Start Baseline Session</button>
            <button class="btn btn-danger" onclick="endSession()">End Session</button>
        </div>
        
        <div class="session-status">
            <h3><span id="sessionIndicator" class="status-indicator status-inactive"></span>Session Status: <span id="sessionType">No Active Session</span></h3>
            <p id="sessionDetails">Start a session to begin algorithmic cost tracking</p>
        </div>
        
        <!-- Checkpoint Tracking Reminder (shown when session active) -->
        <div id="checkpointReminder" style="display: none; background: #d1ecf1; border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; margin: 15px 0;">
            <h4 style="margin: 0 0 10px 0; color: #0c5460;">üìä Session Tracking Active</h4>
            <p style="margin: 0 0 10px 0; color: #0c5460;">
                <strong>This session is being tracked.</strong> Complete workflow:
            </p>
            <ol style="margin: 0; padding-left: 20px; color: #0c5460;">
                <li><strong>Work normally</strong> in Windsurf IDE - no interruptions needed</li>
                <li><strong>When done working:</strong> Click "End Session" button above</li>
                <li><strong>Then click:</strong> "Export Data" button below</li>
                <li><strong>Dashboard generates:</strong> Checkpoint prompt with your session metadata</li>
                <li><strong>You paste into Windsurf:</strong> AI creates checkpoint file with token data</li>
                <li><strong>Export completes:</strong> Dashboard correlates session + token data</li>
            </ol>
            <p style="margin: 10px 0 0 0; color: #0c5460; font-size: 0.9em;">
                <strong>‚ú® Complete tracking!</strong> Start/End buttons track session boundaries, Export captures token usage.
            </p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('economics')">üí∞ Economics</button>
            <button class="tab-btn" onclick="switchTab('health')">üß† System Health</button>
        </div>
        
        <!-- Economics Tab -->
        <div id="economicsTab" class="tab-content active">
        <div class="metrics-grid">
            <div class="metric-card savings">
                <div class="metric-title">Conservative Savings</div>
                <div class="metric-value" id="savingsPercent">--</div>
                <div class="metric-subtitle">30-45% target range</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="savingsProgress" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="metric-card efficiency">
                <div class="metric-title">Retrieval Efficiency</div>
                <div class="metric-value" id="retrievalRatio">--</div>
                <div class="metric-subtitle">Target: >70% retrieval</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="efficiencyProgress" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="metric-card patterns">
                <div class="metric-title">Pattern ROI</div>
                <div class="metric-value" id="patternROI">--</div>
                <div class="metric-subtitle">Validated patterns</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Session Cost</div>
                <div class="metric-value" id="sessionCost">$0.00</div>
                <div class="metric-subtitle">Current session total</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Sessions Tracked</div>
                <div class="metric-value" id="sessionsTracked">0</div>
                <div class="metric-subtitle"><span id="scmsCount">0</span> SCMS ‚Ä¢ <span id="baselineCount">0</span> Baseline</div>
            </div>
        </div>
        
        <!-- Enhanced Economic Analytics (Dual-Inevitability Theorem) -->
        <div class="enhanced-metrics">
            <h2>üí∞ Enhanced Economic Analytics (Dual-Inevitability Theorem)</h2>
            <p class="subtitle">Visual proof that sparse activation is both technically necessary AND economically mandated</p>
            
            <div class="economic-grid">
                <div class="economic-card">
                    <div class="metric-title">üí∞ Margin Transformation</div>
                    <div class="metric-value" style="font-size: 1.8em;">
                        <span style="color: #e74c3c;">$5</span> ‚Üí <span style="color: #27ae60;">$32</span>
                    </div>
                    <div class="metric-subtitle">Monthly platform profit per heavy user</div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(39, 174, 96, 0.1); border-radius: 8px;">
                        <strong style="color: #27ae60;">640% improvement</strong><br>
                        <span style="font-size: 12px; color: #7f8c8d;">Dense: Unsustainable margins ‚Üí Sparse: Profitable at scale</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d; font-style: italic;">
                        The "smoking gun" of economic necessity
                    </div>
                </div>
                
                <div class="economic-card">
                    <div class="metric-title">üìà ROI Over Time</div>
                    <div class="metric-value" id="cumulativeROI">--</div>
                    <div class="metric-subtitle">Cumulative return on SCMS investment</div>
                    <div style="margin-top: 10px;">
                        <small id="roiBreakdown" style="color: #7f8c8d;">Start sessions to track ROI</small>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                        üéØ Target: 200%+ ROI showing compound benefits
                    </div>
                </div>
                
                <div class="economic-card">
                    <div class="metric-title">‚ö° Economic Signature</div>
                    <div id="economicSignatureBadge" class="signature-badge signature-baseline">
                        Baseline
                    </div>
                    <div class="metric-subtitle">System efficiency classification</div>
                    <div style="margin-top: 15px; font-size: 12px; line-height: 1.6; color: #7f8c8d;">
                        <div id="signatureDescription">Measuring system performance...</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 11px; color: #95a5a6;">
                        üéØ Goal: Reach "Compound Benefits" (45-60%)
                    </div>
                </div>
                
                <div class="economic-card">
                    <div class="metric-title">üè¢ Platform Economics</div>
                    <div class="metric-value" style="font-size: 1.5em;" id="platformSavings">$0</div>
                    <div class="metric-subtitle">Projected annual platform savings</div>
                    <div style="margin-top: 10px; font-size: 12px;">
                        <div style="color: #7f8c8d;">
                            <strong>10K users:</strong> <span id="platform10K">$2.88M</span><br>
                            <strong>100K users:</strong> <span id="platform100K">$28.8M</span>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 11px; color: #7f8c8d; font-style: italic;">
                        Market-scale economic implications
                    </div>
                </div>
            </div>
        </div>
        
        <div class="comparison-chart">
            <h3 class="chart-title">Cost Comparison: SCMS vs Baseline</h3>
            <div class="bar-chart">
                <div class="bar" id="baselineBar" style="height: 0%">
                    <span>Baseline<br>$0.00</span>
                </div>
                <div class="bar scms" id="scmsBar" style="height: 0%">
                    <span>SCMS<br>$0.00</span>
                </div>
            </div>
            <p style="text-align: center; color: #7f8c8d; margin-top: 15px;">
                Conservative projections: 30-45% cost reduction through algorithmic validation
            </p>
        </div>
        
        <div class="pattern-list">
            <h3 class="chart-title">Top Performing Patterns</h3>
            <div id="patternsList">
                <p style="text-align: center; color: #7f8c8d; padding: 20px;">
                    Start using SCMS patterns to see ROI analysis
                </p>
            </div>
        </div>
        
        <!-- Data Freshness Warning (hidden by default) -->
        <div id="dataFreshnessWarning" style="display: none;"></div>
        
        <div class="export-section">
            <button class="btn btn-primary" onclick="exportData()">Export Data for Analysis</button>
            <p style="margin-top: 15px; color: #7f8c8d;">
                Export algorithmic measurements for statistical analysis and business case validation
            </p>
        </div>
        
        <!-- Usage Guide Section -->
        <div class="usage-guide">
            <h2>üìö Essential SCMS Workflow Guide</h2>
            
            <h3><span class="step-number">0</span> View Economics Dashboard (Without Opening App)</h3>
            <p><strong>Command:</strong> Run this in your terminal to view economics data:</p>
            <div class="code-block">npm run dashboard</div>
            <p><strong>What it does:</strong> Displays cost comparison, session data, and savings analysis without launching the Electron app. Perfect for quick checks!</p>
            
            <p style="margin-top: 15px;"><strong>To re-open the app with dashboard:</strong></p>
            <div class="code-block">npm run dashboard:app</div>
            <p><strong>Note:</strong> The app auto-opens on first use of SCMS. Use this command to re-launch the dashboard app if you've closed it.</p>
            
            <p style="margin-top: 10px; color: #7f8c8d;"><em>Tip: This dashboard (in-app) provides real-time tracking during development. Use <code>npm run dashboard</code> for quick analysis between sessions.</em></p>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;"><span class="step-number">1</span> Copy the SCMS Startup Prompt (First Time Only)</h3>
                <button class="btn btn-primary" onclick="toggleStartupPrompt()" id="toggleStartupBtn" style="font-size: 14px; padding: 6px 12px;">‚ñº Hide Startup Prompt</button>
            </div>
            <div id="startupPromptSection">
            <p><strong>Action:</strong> Paste this <strong>ONCE when starting a new project</strong> to configure SCMS:</p>
            <div class="prompt-container">
                <button class="copy-btn" onclick="copyPrompt(this, 'startup')">üìã Copy Prompt</button>
                <div class="code-block" id="startup-prompt">SCMS STARTUP (First Session Configuration)

Working on: [project name and brief description]

## SCMS Configuration - Sparse Contextual Memory Scaffolding

**Architecture:** Multi-time-scale cognitive framework (Google Research validated)
- L0 (Foundation): Auto-memories - rare updates, test via probabilistic retrieval
- L1 (Implementation): Validated patterns - medium updates, enforce via mandatory loading
- L4 (Global Rules): Universal constraints - rare updates, check automatically
- L2-L3 (Reference): SOPs & case studies - on-demand retrieval
- L5 (Overflow): Low-frequency patterns - checked only if no validated retrieval from L2/L3
- Dashboard: Session context - frequent updates, working memory

**Retrieval Workflow:** Windsurf hardcoded (L0 ‚Üí L4 ‚Üí L1) ‚Üí SCMS directed (L2/L3 ‚Üí L5 if needed) ‚Üí Generate (if no retrieval) ‚Üí L4 compliance check

**Economic Principle:** Retrieval-first bias (30-45% cost reduction validated)
- Cost asymmetry: Retrieval ($0.018) vs Generation ($0.033) per session
- Target: >70% retrieval-based responses
- Pattern ROI: 3+ reuses for break-even

**Validation Pipeline:**
- L0 (Destructive): Probabilistic retrieval + temporal decay + use-based validation
- L1 (Stable): Deterministic loading + proven utility (‚â•2 uses) + mandatory reference

**Project Context & Promotion Threshold:**
- Check MEMORY_STATUS_DASHBOARD.md for configured threshold
- Greenfield (Weeks 1-4): n‚â•5 uses for promotion
- Establishing (Months 2-3): n‚â•3 uses
- Mature (4+ months): n‚â•2 uses

## Instructions for AI

### Session Start Checklist (BEFORE coding):
1. ‚úÖ Check L4 Global Rules (if rules/GLOBAL_CODING_RULES.md exists)
   - Universal constraints applying to ALL code
   - Examples: "No duplicate code", "Always use X pattern"
   
2. ‚úÖ Check L1 Validated Patterns (WORKSPACE_RULES.md)
   - Project-specific validated patterns (promoted at threshold)
   - These are MANDATORY quality gates, not suggestions
   
3. ‚úÖ Review Memory Dashboard (MEMORY_STATUS_DASHBOARD.md)
   - HIGH urgency patterns (validated but fading - use NOW)
   - Patterns ready for promotion (‚â•threshold uses)
   - Sprint goals and current progress
   
4. ‚úÖ Acknowledge what you've reviewed
   - State: "Reviewed L4 global rules, L1 patterns for [task area]"

### During Development:
1. **CREATE MEMORIES DURING work** (not after!)
   - Pattern discovered ‚Üí Create Cascade memory immediately ‚Üí Continue
   - Do NOT wait until implementation complete
   
2. **DO NOT CREATE markdown documentation files**
   - NO docs/memories/*.md (defeats auto-memory purpose)
   - NO SCMS_REPORT.md or manual tracking files
   - ONLY update: MEMORY_STATUS_DASHBOARD.md for counts/urgency
   
3. **ECONOMIC DECISION TREE** (Retrieval-First):
   - Search L1 (WORKSPACE_RULES) first ‚Üí Use/adapt if found
   - Search L0 (Cascade memories) next ‚Üí Test/refine if found
   - Generate new ONLY if no retrieval options (>75% different)
   - Document immediately for future retrieval
   
4. **FAILURE DOCUMENTATION PRIORITY**:
   - Failures = 10-100√ó more informative than successes
   - Bug patterns (L0) > Anti-patterns (L0) > Failed approaches (L0)
   - Document failures immediately when discovered

### Pattern Promotion:
**When pattern reaches threshold** (see Project Context above):
1. Copy full pattern to WORKSPACE_RULES.md (L1)
2. Include: name, code examples, when to use/avoid, related patterns
3. Update dashboard: Mark as PROMOTED with date

### Session Closure (CRITICAL):
At end of EVERY session, run closure prompt to:
- Document failures first (highest value)
- Update L0/L1 validation pipeline
- Maintain INDEX & cross-references (NOT visual diagrams)
- Update Memory Dashboard (Cascade persistent memory)
- Track economics (cost/savings/ROI)
- Maintain organizational framing (L0/L1/Dashboard boundaries)

**Without session closure, SCMS degrades into passive documentation!**

Ready to configure SCMS for this project. Let's start by checking existing patterns.</div>
            </div>
            <p style="margin-top: 10px;"><strong>When to use:</strong> Only needed once per project during initial setup. After configuration, use the Session Start Prompt (below) for daily work.</p>
            </div>
            
            <h3><span class="step-number">2</span> Copy the Session Start Prompt (Daily Use)</h3>
            <p><strong>Action:</strong> Paste this at the <strong>start of EVERY session</strong> to activate SCMS optimization:</p>
            <div class="prompt-container">
                <button class="copy-btn" onclick="copyPrompt(this, 'session-start')">üìã Copy Prompt</button>
                <div class="code-block" id="session-start-prompt">SCMS SESSION START

Working on: [brief task description]

Please operate using SCMS (Sparse Contextual Memory Scaffolding) framework:

1. L0/L1 RETRIEVAL FIRST
   - Check scms/INDEX.md for relevant patterns
   - Review validation records for similar work
   - Cite existing patterns before generating new solutions

2. LAYER STRUCTURE & RETRIEVAL PRIORITY
   AUTOMATIC RETRIEVAL (hardcoded AI behavior):
   - L0: Auto-gen memories (Cascade) - retrieved first automatically
   - L4: Global Rules - checked automatically
   - L1: Workspace Rules (WORKSPACE_RULES) - loaded automatically
   
   SELF-DIRECTED RETRIEVAL (prompt-guided, check when relevant):
   - L2: SOPs (5+ uses) - detailed procedures when L1 references them
   - L3: Case Studies - complete examples for learning
   - L5: Overflow - low-frequency patterns (only if no validated retrieval from L2/L3)
   
   GENERATION & FINAL VALIDATION:
   - Generate new solution (only if no retrieval from ALL other layers)
   - L4: Global Rules final compliance check on all output
   
   SESSION CONTEXT:
   - Dashboard: Current task/objectives (this conversation)
   - Memory Dashboard: Pattern tracking system (separate)
   
   Actual retrieval flow: L0 ‚Üí L4 ‚Üí L1 ‚Üí [L2/L3 ‚Üí L5 if needed] ‚Üí Generate (if no retrieval) ‚Üí L4 compliance check

3. MIND-MAP FRAMEWORK = ORGANIZATIONAL FRAMING
   - NOT visual diagrams
   - IS: Tags, cross-references, semantic coherence
   - Maintain L0/L1/Dashboard boundaries

4. ECONOMIC TRACKING
   - Retrieval ratio matters (currently: 0%, target: 30-50%)
   - Pattern reuse = cost savings
   - Session closure updates economics

5. FAILURE DOCUMENTATION PRIORITY
   - Failures = 3-10√ó more informative than successes
   - Bug patterns (L0) - prevent entire bug classes
   - Anti-patterns (L0) - design principles  
   - Failed approaches (L0) - avoid wasted effort
   - Edge cases (L1) - special handling
   - Document "what NOT to do" first

6. SESSION CLOSURE REMINDER
   - After work: pattern validation, L0/L1 updates, economic tracking
   - Target: 10-15 minutes
   - Update INDEX.md with tags/cross-refs (not visual graphs)
   - Document failures discovered (higher value than successes)

Let's start by checking for relevant existing patterns, then proceed with the work.</div>
            </div>
            <p style="margin-top: 10px;"><strong>Pro Tip:</strong> This prompt is self-contained and works even with stale context. Use at the start of every session to activate full SCMS optimization.</p>
            
            <h3><span class="step-number">3</span> Use This Dashboard During Development</h3>
            <ol>
                <li><strong>Click "Start SCMS Session"</strong> when you begin working with SCMS patterns</li>
                <li><strong>Click "Start Baseline Session"</strong> for comparison without patterns</li>
                <li><strong>Develop normally</strong> - the tracker auto-captures token usage</li>
                <li><strong>Click "End Session"</strong> when you finish a work segment</li>
                <li><strong>Export data</strong> for business case validation and statistical analysis</li>
            </ol>
            
            <div class="critical-box">
                <h3>üö® CRITICAL: Validation Commit Layer (Most Important Step!)</h3>
                <p><strong>Architectural Note:</strong> Also called "Session Closure" in workflows. This is a <strong>mandatory architectural component</strong> that commits validated learnings back into the dual validation pipeline.</p>
                <p><strong>Why it matters:</strong> Without this phase, SCMS degrades into passive documentation instead of active continual learning.</p>
                <p><strong>When:</strong> At the end of EVERY development session</p>
                <p><strong>What to do:</strong> Copy and paste this prompt to your AI:</p>
            </div>
            
            <div class="prompt-container">
                <button class="copy-btn" onclick="copyPrompt(this, 'session-closure')">üìã Copy Prompt</button>
                <div class="code-block" id="session-closure-prompt">SCMS SESSION CLOSURE - CRITICAL SYSTEM UPDATE

Great work on this feature! Now let's close the SCMS optimization loop:

1. PATTERN REFLECTION & VALIDATION
   - FAILURES FIRST (3-10√ó more informative than successes)
2. L0/L1 VALIDATION PIPELINE UPDATE (threshold: 2+ uses)
3. INDEX & CROSS-REFERENCE MAINTENANCE (NOT visual diagrams)
4. MEMORY DASHBOARD UPDATE (Cascade persistent memory)
5. ECONOMIC DASHBOARD UPDATE (cost/savings/ROI)
6. ORGANIZATIONAL FRAMING MAINTENANCE (L0/L1/Dashboard boundaries)
7. SYSTEM OPTIMIZATION (health status & compliance)

This ensures SCMS continues optimizing and compounding value over time.

üìä NOTE: Checkpoint file creation happens automatically when you click "Export Data" in the dashboard.</div>
            </div>
            
            <h3><span class="step-number">4</span> What Happens During Session Closure</h3>
            <ol>
                <li><strong>Pattern Reflection:</strong> Reviews patterns, anti-patterns, and bug patterns discovered. Failures documented first (highest value).</li>
                <li><strong>L0/L1 Pipeline Update:</strong> Promotes validated patterns from L0 ‚Üí L1 (threshold: see docs/scms/MEMORY_STATUS_DASHBOARD.md)</li>
                <li><strong>INDEX Maintenance:</strong> Updates scms/INDEX.md with tags and cross-references (organizational structure, NOT visual diagrams)</li>
                <li><strong>Memory Dashboard:</strong> Saves key patterns to Cascade persistent memory with tags</li>
                <li><strong>Economic Dashboard:</strong> Records cost savings, retrieval ratio, and ROI measurements</li>
                <li><strong>Organizational Framing:</strong> Maintains L0/L1/Dashboard boundaries and semantic coherence</li>
                <li><strong>System Optimization:</strong> Identifies opportunities for improvement</li>
            </ol>
            
            <p style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                <strong>üìä Economic Tracking:</strong> When you're ready to export data, click "Export Data" in the dashboard. It will automatically prompt you to create a checkpoint file with all token usage from this conversation.
            </p>
            
            <p style="margin-top: 25px; padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #27ae60;">
                <strong>üí° Pro Tip:</strong> Session closure is what transforms SCMS from a documentation system into a <strong>continually learning optimization engine</strong>. It's the compound interest of development workflows!
            </p>
            
            <p style="margin-top: 20px; text-align: center; color: #7f8c8d;">
                <strong>Target Result:</strong> Conservative 30-45% cost reduction through algorithmic validation<br>
                <strong>Annual Savings:</strong> $200-400 for heavy AI users<br>
                <strong>Platform Savings:</strong> $2-3M annually for 100K users
            </p>
        </div>
        </div>
        <!-- End Economics Tab -->
        
        <!-- System Health Tab -->
        <div id="healthTab" class="tab-content">
            <!-- System Health Overview -->
            <div class="health-overview">
                <div class="health-status-header">
                    <div class="health-icon" id="healthIcon">üü¢</div>
                    <div class="health-title">
                        <h2>System Health: <span id="healthStatusText">GREEN</span></h2>
                        <p class="health-subtitle">Real-time performance tracking ‚Ä¢ Last updated: <span id="lastUpdateTime">--</span></p>
                    </div>
                </div>
                
                <div class="health-metrics">
                    <!-- Retrieval Performance -->
                    <div class="health-metric green" id="retrievalMetric">
                        <div class="health-metric-title">‚ö° Retrieval Performance</div>
                        <div class="health-metric-value green" id="avgRetrievalTime">2.3s</div>
                        <div class="health-metric-details">
                            <div>Max: <span id="maxRetrievalTime">5.1s</span></div>
                            <div>Retrievals: <span id="retrievalCount">12</span> this session</div>
                            <div class="health-metric-trend" id="retrievalTrend">Stable ‚Üí</div>
                        </div>
                    </div>
                    
                    <!-- Pattern Success Rate -->
                    <div class="health-metric green" id="successMetric">
                        <div class="health-metric-title">‚úÖ Pattern Success Rate</div>
                        <div class="health-metric-value green" id="successRate">80%</div>
                        <div class="health-metric-details">
                            <div>Success: <span id="successCount">12</span> / <span id="totalAttempts">15</span></div>
                            <div>New patterns: <span id="newPatternsCount">3</span></div>
                            <div class="health-metric-trend improving" id="successTrend">+5% vs baseline</div>
                        </div>
                    </div>
                    
                    <!-- Scan Efficiency -->
                    <div class="health-metric green" id="scanMetric">
                        <div class="health-metric-title">üîç Scan Efficiency</div>
                        <div class="health-metric-value" id="scanEfficiency">14%</div>
                        <div class="health-metric-details">
                            <div>Relevant: <span id="patternsUsed">4</span> / <span id="memoriesScanned">28</span></div>
                            <div>Noise: <span id="irrelevantPatterns">24</span> patterns skipped</div>
                            <div class="health-metric-trend" id="scanTrend">Optimal range</div>
                        </div>
                    </div>
                    
                    <!-- Temporal Health -->
                    <div class="health-metric green" id="temporalMetric">
                        <div class="health-metric-title">üìâ Temporal Health</div>
                        <div class="health-metric-value green" id="unusedCount">5</div>
                        <div class="health-metric-details">
                            <div>Unused 30d: <span id="unused30d">5</span> patterns</div>
                            <div>Avg age: <span id="avgAge">12</span> days</div>
                            <div class="health-metric-trend" id="temporalTrend">üü¢ Healthy</div>
                        </div>
                    </div>
                    
                    <!-- Economic Efficiency -->
                    <div class="health-metric green" id="economicMetric">
                        <div class="health-metric-title">üí∞ Economic Efficiency</div>
                        <div class="health-metric-value green" id="economicEfficiency">23%</div>
                        <div class="health-metric-details">
                            <div>Savings: <span id="currentSavings">45%</span></div>
                            <div>Retrieved: <span id="patternsRetrieved">3</span> patterns</div>
                            <div class="health-metric-trend improving" id="economicTrend">+5% vs baseline</div>
                        </div>
                    </div>
                    
                    <!-- Memory Capacity -->
                    <div class="health-metric green" id="capacityMetric">
                        <div class="health-metric-title">üß† Memory Capacity</div>
                        <div class="health-metric-value green" id="memoryCount">28</div>
                        <div class="health-metric-details">
                            <div>Zone: <span id="capacityZone">Green (0-35)</span></div>
                            <div>Headroom: <span id="headroom">7</span> memories</div>
                            <div class="health-metric-trend" id="capacityTrend">No degradation</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recommendations Panel -->
            <div class="recommendations-panel" id="recommendationsPanel">
                <h3>üí° Smart Recommendations</h3>
                <div id="recommendationsList">
                    <div class="recommendation-item">
                        <span class="recommendation-icon">‚úÖ</span>
                        <span>System performing optimally at 28 memories</span>
                    </div>
                    <div class="recommendation-item">
                        <span class="recommendation-icon">üìà</span>
                        <span>Continue to 35-40 memories before reassessing</span>
                    </div>
                    <div class="recommendation-item">
                        <span class="recommendation-icon">üëÄ</span>
                        <span>Monitor retrieval time for degradation</span>
                    </div>
                </div>
            </div>
            
            <!-- Warnings Panel (hidden by default) -->
            <div class="warning-panel" id="warningsPanel" style="display: none;">
                <h3>‚ö†Ô∏è Performance Warnings</h3>
                <div id="warningsList"></div>
            </div>
            
            <!-- Session History -->
            <div class="health-overview" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">üìÖ Recent Sessions</h3>
                <div id="sessionHistoryList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        <!-- End System Health Tab -->
    </div>

    <script>
        // Check if running in Electron
        const isElectron = typeof window.electronAPI !== 'undefined';
        
        let monitorActive = false;
        let currentSessionType = null;
        let dashboardData = null;
        let dataWatcher = null;
        let performanceData = null;
        let healthRefreshInterval = null;
        
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate selected button
            event.target.classList.add('active');
            
            // Load health data if switching to health tab
            if (tabName === 'health') {
                loadSystemHealth();
            }
        }
        
        // Load system health data
        async function loadSystemHealth() {
            try {
                const response = await fetch('../scms-performance-data.json');
                performanceData = await response.json();
                updateHealthMetrics(performanceData);
                console.log('[health] Performance data loaded successfully');
            } catch (error) {
                console.error('[health] Failed to load performance data:', error);
                // Set default values if load fails
                performanceData = {
                    currentMetrics: {
                        memoryCount: 0,
                        avgRetrievalTime: 0,
                        successRate: 0,
                        scanEfficiency: 0,
                        unusedMemories30d: 0,
                        economicEfficiency: 0
                    },
                    healthStatus: 'unknown',
                    warnings: ['Failed to load performance data'],
                    recommendations: ['Check scms-performance-data.json file']
                };
                updateHealthMetrics(performanceData);
            }
        }
        
        // Update health metrics UI
        function updateHealthMetrics(data) {
            const metrics = data.currentMetrics;
            const thresholds = data.thresholds;
            
            // Update last update time
            document.getElementById('lastUpdateTime').textContent = new Date(metrics.lastUpdated).toLocaleString();
            
            // Update overall health status
            const healthIcon = document.getElementById('healthIcon');
            const healthStatusText = document.getElementById('healthStatusText');
            
            switch(data.healthStatus) {
                case 'green':
                    healthIcon.textContent = 'üü¢';
                    healthStatusText.textContent = 'GREEN';
                    healthStatusText.style.color = '#27ae60';
                    break;
                case 'yellow':
                    healthIcon.textContent = 'üü°';
                    healthStatusText.textContent = 'YELLOW';
                    healthStatusText.style.color = '#f39c12';
                    break;
                case 'orange':
                    healthIcon.textContent = 'üü†';
                    healthStatusText.textContent = 'ORANGE';
                    healthStatusText.style.color = '#e67e22';
                    break;
                case 'red':
                    healthIcon.textContent = 'üî¥';
                    healthStatusText.textContent = 'RED';
                    healthStatusText.style.color = '#e74c3c';
                    break;
                default:
                    healthIcon.textContent = '‚ùì';
                    healthStatusText.textContent = 'UNKNOWN';
                    healthStatusText.style.color = '#95a5a6';
            }
            
            // Update retrieval performance
            document.getElementById('avgRetrievalTime').textContent = metrics.avgRetrievalTime + 's';
            document.getElementById('maxRetrievalTime').textContent = metrics.maxRetrievalTime + 's';
            document.getElementById('retrievalCount').textContent = metrics.patternsRetrieved || 12;
            updateMetricColor('retrievalMetric', metrics.avgRetrievalTime, thresholds.retrievalTime);
            
            // Update success rate
            document.getElementById('successRate').textContent = metrics.successRate + '%';
            document.getElementById('successCount').textContent = metrics.patternsRetrieved || 12;
            document.getElementById('totalAttempts').textContent = (metrics.patternsRetrieved + metrics.patternsGenerated) || 15;
            document.getElementById('newPatternsCount').textContent = metrics.patternsGenerated || 3;
            updateMetricColor('successMetric', metrics.successRate, thresholds.successRate, true);
            
            // Update scan efficiency
            document.getElementById('scanEfficiency').textContent = metrics.scanEfficiency + '%';
            document.getElementById('patternsUsed').textContent = Math.floor(metrics.memoryCount * metrics.scanEfficiency / 100);
            document.getElementById('memoriesScanned').textContent = metrics.memoryCount;
            document.getElementById('irrelevantPatterns').textContent = metrics.memoryCount - Math.floor(metrics.memoryCount * metrics.scanEfficiency / 100);
            updateMetricColor('scanMetric', metrics.scanEfficiency, thresholds.scanEfficiency, true);
            
            // Update temporal health
            document.getElementById('unusedCount').textContent = metrics.unusedMemories30d;
            document.getElementById('unused30d').textContent = metrics.unusedMemories30d;
            document.getElementById('avgAge').textContent = metrics.avgPatternAge || 12;
            updateMetricColor('temporalMetric', metrics.unusedMemories30d, thresholds.unusedMemories);
            
            // Update economic efficiency
            document.getElementById('economicEfficiency').textContent = metrics.economicEfficiency + '%';
            document.getElementById('currentSavings').textContent = '45%'; // From economics data
            document.getElementById('patternsRetrieved').textContent = metrics.patternsRetrieved || 3;
            updateMetricColor('economicMetric', metrics.economicEfficiency, { green: 20, yellow: 15, orange: 10, red: 0 }, true);
            
            // Update memory capacity
            document.getElementById('memoryCount').textContent = metrics.memoryCount;
            const headroom = 35 - metrics.memoryCount;
            document.getElementById('headroom').textContent = headroom > 0 ? headroom : 0;
            document.getElementById('capacityZone').textContent = getCapacityZone(metrics.memoryCount);
            updateMetricColor('capacityMetric', metrics.memoryCount, { green: 35, yellow: 50, orange: 70, red: 999 });
            
            // Update recommendations
            updateRecommendations(data.recommendations);
            
            // Update warnings
            updateWarnings(data.warnings);
            
            // Update session history
            updateSessionHistory(data.sessionHistory);
        }
        
        // Helper function to update metric colors based on thresholds
        function updateMetricColor(elementId, value, thresholds, higherIsBetter = false) {
            const element = document.getElementById(elementId);
            const valueElement = element.querySelector('.health-metric-value');
            
            let colorClass = 'green';
            
            if (higherIsBetter) {
                if (value >= thresholds.green) colorClass = 'green';
                else if (value >= thresholds.yellow) colorClass = 'yellow';
                else if (value >= thresholds.orange) colorClass = 'orange';
                else colorClass = 'red';
            } else {
                if (value <= thresholds.green) colorClass = 'green';
                else if (value <= thresholds.yellow) colorClass = 'yellow';
                else if (value <= thresholds.orange) colorClass = 'orange';
                else colorClass = 'red';
            }
            
            // Remove all color classes
            element.classList.remove('green', 'yellow', 'orange', 'red');
            valueElement.classList.remove('green', 'yellow', 'orange', 'red');
            
            // Add appropriate color class
            element.classList.add(colorClass);
            valueElement.classList.add(colorClass);
        }
        
        // Get capacity zone description
        function getCapacityZone(memoryCount) {
            if (memoryCount <= 35) return 'Green (0-35)';
            if (memoryCount <= 50) return 'Yellow (35-50)';
            if (memoryCount <= 70) return 'Orange (50-70)';
            return 'Red (70+)';
        }
        
        // Update recommendations panel
        function updateRecommendations(recommendations) {
            const listElement = document.getElementById('recommendationsList');
            listElement.innerHTML = '';
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <span class="recommendation-icon">üí°</span>
                    <span>${rec}</span>
                `;
                listElement.appendChild(item);
            });
        }
        
        // Update warnings panel
        function updateWarnings(warnings) {
            const panel = document.getElementById('warningsPanel');
            const listElement = document.getElementById('warningsList');
            
            if (warnings.length === 0) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                listElement.innerHTML = '';
                
                warnings.forEach(warning => {
                    const item = document.createElement('div');
                    item.style.marginBottom = '8px';
                    item.innerHTML = `‚ö†Ô∏è ${warning}`;
                    listElement.appendChild(item);
                });
            }
        }
        
        // Update session history
        function updateSessionHistory(sessions) {
            const listElement = document.getElementById('sessionHistoryList');
            listElement.innerHTML = '';
            
            if (!sessions || sessions.length === 0) {
                listElement.innerHTML = '<p style="color: #7f8c8d;">No session history available</p>';
                return;
            }
            
            // Show last 3 sessions
            sessions.slice(0, 3).forEach(session => {
                const item = document.createElement('div');
                item.style.padding = '15px';
                item.style.background = '#f8f9fa';
                item.style.borderRadius = '8px';
                item.style.marginBottom = '10px';
                
                const date = new Date(session.date).toLocaleDateString();
                item.innerHTML = `
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">${date}</div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">
                        <div>Retrieval: ${session.retrievalTime}s avg ‚Ä¢ Success: ${session.successRate}%</div>
                        <div>Savings: ${session.economicSavings}% ‚Ä¢ Memories: ${session.memoryCount}</div>
                        <div>Created: ${session.patternsCreated} ‚Ä¢ Retrieved: ${session.patternsRetrieved}</div>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }
        
        // Auto-refresh health data every minute
        function startHealthRefresh() {
            // Initial load
            loadSystemHealth();
            
            // Refresh every 60 seconds
            healthRefreshInterval = setInterval(() => {
                if (document.getElementById('healthTab').classList.contains('active')) {
                    loadSystemHealth();
                    console.log('[health] Auto-refresh triggered');
                }
            }, 60000); // 60 seconds
        }
        
        // Copy prompt to clipboard
        function copyPrompt(button, promptId) {
            const promptElement = document.getElementById(promptId + '-prompt');
            if (!promptElement) {
                console.error('[copy] Prompt element not found:', promptId);
                return;
            }
            
            const text = promptElement.textContent;
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(button);
                    console.log('[copy] ‚úÖ Prompt copied:', promptId);
                }).catch(err => {
                    console.error('[copy] Failed to copy:', err);
                    fallbackCopy(text, button);
                });
            } else {
                // Fallback for older browsers
                fallbackCopy(text, button);
            }
        }
        
        // Fallback copy method for older browsers
        function fallbackCopy(text, button) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess(button);
                console.log('[copy] ‚úÖ Prompt copied (fallback)');
            } catch (err) {
                console.error('[copy] Fallback copy failed:', err);
                alert('Failed to copy. Please select and copy manually.');
            }
            
            document.body.removeChild(textarea);
        }
        
        // Show visual feedback on successful copy
        function showCopySuccess(button) {
            const originalText = button.textContent;
            button.classList.add('copied');
            button.textContent = 'Copied!';
            
            setTimeout(() => {
                button.classList.remove('copied');
                button.textContent = originalText;
            }, 2000);
        }
        
        // Toggle startup prompt visibility
        function toggleStartupPrompt() {
            const section = document.getElementById('startupPromptSection');
            const button = document.getElementById('toggleStartupBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = '‚ñº Hide Startup Prompt';
                localStorage.setItem('scms_startup_prompt_visible', 'true');
            } else {
                section.style.display = 'none';
                button.textContent = '‚ñ∂ Show Startup Prompt';
                localStorage.setItem('scms_startup_prompt_visible', 'false');
            }
        }
        
        // Restore startup prompt visibility on load
        function restoreStartupPromptState() {
            const isVisible = localStorage.getItem('scms_startup_prompt_visible');
            const section = document.getElementById('startupPromptSection');
            const button = document.getElementById('toggleStartupBtn');
            
            // Default to hidden after first use (most users won't need it again)
            if (isVisible === 'false') {
                section.style.display = 'none';
                button.textContent = '‚ñ∂ Show Startup Prompt';
            }
        }
        
        // Dashboard control functions
        async function startSCMSSession() {
            await startSession('scms', 'SCMS Session Active', 'Using L0/L1 patterns + checkpoint auto-tracking');
        }
        
        async function startBaselineSession() {
            await startSession('baseline', 'Baseline Session Active', 'Fresh exploration without SCMS patterns');
        }
        
        async function startSession(type, title, description) {
            if (!isElectron) {
                alert('Checkpoint monitoring requires Electron environment');
                return;
            }
            
            currentSessionType = type;
            
            // üÜï AUTO-STAMP: Create new session with explicit start timestamp
            const sessionStamp = {
                action: 'session_started',
                type: type,
                timestamp: new Date().toISOString(),
                dashboardVersion: '1.0.0',
                userInitiated: true
            };
            
            // Save session stamp to localStorage for recovery
            localStorage.setItem('scms_current_session', JSON.stringify(sessionStamp));
            
            // Start checkpoint monitor
            const result = await window.electronAPI.startCheckpointMonitor(sessionStamp);
            if (result.ok) {
                monitorActive = true;
                updateSessionDisplay(title, description + ' ‚Ä¢ Monitor running ‚Ä¢ Started: ' + new Date().toLocaleTimeString());
                console.log('[dashboard] ‚úÖ Session started with auto-stamp:', sessionStamp);
            } else {
                updateSessionDisplay(title, description + ' ‚Ä¢ Monitor failed: ' + result.error);
                console.error('[dashboard] Failed to start monitor:', result.error);
            }
        }
        
        async function endSession() {
            if (!isElectron) return;
            
            // üÜï AUTO-STAMP: Mark session as ended by user
            const sessionStamp = {
                action: 'session_ended',
                timestamp: new Date().toISOString(),
                userInitiated: true,
                reason: 'manual'
            };
            
            // Stop checkpoint monitor with end stamp
            if (monitorActive) {
                const result = await window.electronAPI.stopCheckpointMonitor(sessionStamp);
                if (result.ok) {
                    console.log('[dashboard] ‚úÖ Session ended with auto-stamp:', sessionStamp);
                } else {
                    console.error('[dashboard] Failed to stop monitor:', result.error);
                }
            }
            
            // Clear session from localStorage
            localStorage.removeItem('scms_current_session');
            
            monitorActive = false;
            currentSessionType = null;
            
            // Reload dashboard data to show final results
            await loadDashboardData();
            
            updateSessionDisplay('Session Ended', 'Ended: ' + new Date().toLocaleTimeString() + ' ‚Ä¢ Data ready for export');
        }
        
        function updateSessionDisplay(type, details) {
            document.getElementById('sessionType').textContent = type;
            document.getElementById('sessionDetails').textContent = details;
            
            const indicator = document.getElementById('sessionIndicator');
            const reminder = document.getElementById('checkpointReminder');
            
            if (type.includes('Active')) {
                indicator.className = 'status-indicator status-active';
                // Show checkpoint reminder when session is active
                reminder.style.display = 'block';
            } else {
                indicator.className = 'status-indicator status-inactive';
                // Hide reminder when session ends
                reminder.style.display = 'none';
            }
        }
        
        async function exportData() {
            if (!isElectron) {
                alert('Export requires Electron environment');
                return;
            }
            
            // Get session metadata from localStorage
            const sessionStampStr = localStorage.getItem('scms_current_session');
            const sessionStamp = sessionStampStr ? JSON.parse(sessionStampStr) : null;
            
            if (!sessionStamp) {
                alert('‚ö†Ô∏è No active session found!\n\nPlease:\n1. Click "Start Session" first\n2. Do your work\n3. Click "End Session"\n4. Then export\n\nThis ensures accurate session tracking.');
                return;
            }
            
            // Calculate duration if end time exists
            const startTime = new Date(sessionStamp.startTime);
            const endTime = sessionStamp.endTime ? new Date(sessionStamp.endTime) : new Date();
            const durationMs = endTime - startTime;
            const durationMin = Math.floor(durationMs / 60000);
            
            // Step 1: Prompt user to create checkpoint in Windsurf
            const checkpointPrompt = `üìä CREATE CHECKPOINT FOR DASHBOARD

Please create a checkpoint file for this session's economic tracking:

1. Extract all <system_warning>Token usage: entries from this conversation
2. Create file: checkpoints/checkpoint-${sessionStamp.id}.txt
3. Include session metadata at top:

CHECKPOINT - Session ${sessionStamp.id}
Session ID: ${sessionStamp.id}
Type: ${sessionStamp.type}
Start Time: ${sessionStamp.startTime}
End Time: ${sessionStamp.endTime || new Date().toISOString()}
Duration: ${durationMin} minutes (${durationMs}ms)

4. Then list all token usage warnings from this conversation:

<system_warning>Token usage: [copy all entries from this conversation]</system_warning>
...

This correlates the token data with the session tracked by the dashboard.`;

            
            // Copy to clipboard for easy pasting
            try {
                await navigator.clipboard.writeText(checkpointPrompt);
                
                // Show modal with instructions
                const proceed = confirm(`üìä CHECKPOINT CREATION REQUIRED

To export accurate data, we need to create a checkpoint file first.

‚úÖ The checkpoint creation prompt has been copied to your clipboard!

STEPS:
1. Click OK to continue
2. Paste the prompt into Windsurf (Ctrl+V)
3. AI will create the checkpoint file automatically
4. Wait for "checkpoint created" confirmation (~5 seconds)
5. Come back here and the export will complete automatically

Click OK when ready to paste into Windsurf.`);
                
                if (!proceed) {
                    console.log('[export] User cancelled checkpoint creation');
                    return;
                }
                
                // Show waiting modal
                alert(`‚è≥ WAITING FOR CHECKPOINT FILE

Go to Windsurf now and:
1. Paste the prompt (Ctrl+V)
2. Wait for AI to create the checkpoint file
3. Come back here and click OK

The dashboard will automatically detect the new checkpoint and export the data.`);
                
                // Wait a moment for file to be created
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Reload dashboard data to pick up new checkpoint
                console.log('[export] Reloading data to include new checkpoint...');
                await loadDashboardData();
                
            } catch (err) {
                console.warn('[export] Could not copy to clipboard:', err);
                alert(`üìä CHECKPOINT CREATION

Please paste this into Windsurf to create the checkpoint:\n\n${checkpointPrompt}\n\nThen click OK to continue export.`);
            }
            
            // Step 2: Proceed with export
            await loadDashboardData();
            
            if (dashboardData) {
                // ‚úÖ UPDATE EXPORT DATE TO CURRENT TIME
                const exportData = {
                    ...dashboardData,
                    exportDate: new Date().toISOString(),
                    exportMetadata: {
                        exportedAt: new Date().toISOString(),
                        exportedBy: 'Dashboard UI',
                        dashboardVersion: '3.2',
                        totalSessionsExported: dashboardData.sessions?.length || 0
                    }
                };
                
                // Validate export data
                console.log('[export] ‚úÖ Exporting fresh data:');
                console.log('[export] Export timestamp:', exportData.exportDate);
                console.log('[export] Total sessions:', exportData.sessions?.length || 0);
                console.log('[export] SCMS sessions:', exportData.analysis?.scmsSessions || 0);
                console.log('[export] Baseline sessions:', exportData.analysis?.baselineSessions || 0);
                
                // ‚úÖ FIRST: Update source file (fixes export disconnect bug)
                try {
                    const saveResult = await window.electronAPI.saveDashboardData(exportData);
                    if (saveResult.ok) {
                        console.log('[export] ‚úÖ Source file updated successfully');
                    } else {
                        console.warn('[export] ‚ö†Ô∏è Failed to update source file:', saveResult.error);
                    }
                } catch (err) {
                    console.error('[export] ‚ùå Error updating source file:', err);
                }
                
                // ‚úÖ SECOND: Create download to ~/Downloads
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `scms-economics-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                
                // ‚úÖ Clear staleness warning immediately (data is now fresh)
                displayDataFreshnessWarning({ fresh: true });
                
                // ‚úÖ THIRD: Update dashboard UI with fresh data
                updateDashboardUI(exportData);
                console.log('[export] ‚úÖ Dashboard UI updated with new checkpoint data');
                
                alert(`‚úÖ Dashboard data exported successfully!\n\nüìä Sessions exported: ${exportData.sessions?.length || 0}\nüí∞ Savings: ${exportData.analysis?.savingsPercent?.toFixed(1)}%\n\n‚úÖ Source file updated\n‚úÖ Download created\n‚úÖ Checkpoint file included\n‚úÖ Dashboard metrics updated`);
            } else {
                alert('No dashboard data available to export');
            }
        }
        
        function validateDataFreshness(data) {
            if (!data || !data.exportDate) {
                return {
                    fresh: false,
                    warning: '‚ö†Ô∏è No export date found - data may be invalid',
                    daysSinceExport: null
                };
            }
            
            const exportDate = new Date(data.exportDate);
            const now = new Date();
            const daysDiff = (now - exportDate) / (1000 * 60 * 60 * 24);
            
            // Data is stale if older than 6 hours (0.25 days)
            const isStale = daysDiff > 0.25;
            
            let warning = null;
            if (daysDiff > 7) {
                warning = `üö® CRITICAL: Data is ${daysDiff.toFixed(1)} days old! Dashboard tracking may be broken.`;
            } else if (daysDiff > 1) {
                warning = `‚ö†Ô∏è WARNING: Data is ${daysDiff.toFixed(1)} days old. Consider re-exporting.`;
            } else if (isStale) {
                warning = `‚ö†Ô∏è Data is ${(daysDiff * 24).toFixed(1)} hours old. May not reflect latest sessions.`;
            }
            
            return {
                fresh: !isStale,
                warning: warning,
                daysSinceExport: daysDiff,
                exportDate: exportDate,
                lastExport: exportDate.toLocaleString()
            };
        }
        
        function displayDataFreshnessWarning(freshness) {
            const warningDiv = document.getElementById('dataFreshnessWarning');
            
            if (!freshness.fresh && freshness.warning) {
                warningDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <strong>${freshness.warning}</strong><br>
                        <small>Last export: ${freshness.lastExport || 'Unknown'}</small><br>
                        <small>Savings percentage and session counts may be outdated.</small><br>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 15px; background: #ffc107; border: none; border-radius: 4px; cursor: pointer;">üîÑ Reload Dashboard</button>
                    </div>
                `;
                warningDiv.style.display = 'block';
                console.warn('[dashboard] Data staleness detected:', freshness);
            } else {
                warningDiv.style.display = 'none';
            }
        }
        
        async function loadDashboardData() {
            if (!isElectron) return;
            
            const result = await window.electronAPI.loadDashboardData();
            if (result.ok) {
                dashboardData = result.data;
                
                // ‚úÖ VALIDATE DATA FRESHNESS
                const freshness = validateDataFreshness(dashboardData);
                displayDataFreshnessWarning(freshness);
                
                // Log freshness status
                if (!freshness.fresh) {
                    console.warn('[dashboard] ‚ö†Ô∏è Stale data detected!');
                    console.warn('[dashboard] Export date:', freshness.lastExport);
                    console.warn('[dashboard] Days since export:', freshness.daysSinceExport?.toFixed(2));
                } else {
                    console.log('[dashboard] ‚úÖ Data is fresh (< 6 hours old)');
                }
                
                updateDashboardUI(dashboardData);
                console.log('[dashboard] Data loaded:', dashboardData);
            } else {
                console.warn('[dashboard] No data available:', result.error);
            }
        }
        
        function updateDashboardUI(data) {
            if (!data || !data.analysis) return;
            
            const { analysis, sessions, patterns } = data;
            
            // üìä LOG SESSION TRACKING STATUS
            console.log('[dashboard] üìä Session Tracking Status:');
            console.log('[dashboard] Total sessions:', sessions?.length || 0);
            console.log('[dashboard] SCMS sessions:', analysis.scmsSessions || 0);
            console.log('[dashboard] Baseline sessions:', analysis.baselineSessions || 0);
            console.log('[dashboard] Savings:', analysis.savingsPercent?.toFixed(1) + '%' || 'N/A');
            
            // ‚ö†Ô∏è DETECT TRACKING ISSUES
            if (sessions && sessions.length > (analysis.scmsSessions + analysis.baselineSessions)) {
                console.warn('[dashboard] ‚ö†Ô∏è Session count mismatch! Some sessions may not be classified correctly.');
            }
            
            // Update session tracking metrics
            const totalSessions = sessions?.length || 0;
            const scmsSessions = analysis.scmsSessions || 0;
            const baselineSessions = analysis.baselineSessions || 0;
            
            document.getElementById('sessionsTracked').textContent = totalSessions;
            document.getElementById('scmsCount').textContent = scmsSessions;
            document.getElementById('baselineCount').textContent = baselineSessions;
            
            // Update savings metrics
            const savingsPercent = Math.max(0, analysis.savingsPercent || 0);
            document.getElementById('savingsPercent').textContent = `${savingsPercent.toFixed(1)}%`;
            document.getElementById('savingsProgress').style.width = `${Math.min(savingsPercent / 45 * 100, 100)}%`;
            
            // Update current session if active
            const currentSession = sessions.find(s => !s.endTime);
            if (currentSession) {
                document.getElementById('sessionCost').textContent = `$${currentSession.totalCost.toFixed(4)}`;
                const retrievalRatio = (currentSession.retrievalRatio * 100) || 0;
                document.getElementById('retrievalRatio').textContent = `${retrievalRatio.toFixed(1)}%`;
                document.getElementById('efficiencyProgress').style.width = `${Math.min(retrievalRatio, 100)}%`;
            }
            
            // Enhanced Economic Metrics
            updateEnhancedEconomics(data);
            
            // Update comparison chart
            const maxCost = Math.max(analysis.scmsAvgCost, analysis.baselineAvgCost);
            if (maxCost > 0) {
                const baselineHeight = (analysis.baselineAvgCost / maxCost) * 100;
                const scmsHeight = (analysis.scmsAvgCost / maxCost) * 100;
                
                document.getElementById('baselineBar').style.height = `${baselineHeight}%`;
                document.getElementById('baselineBar').innerHTML = `<span>Baseline<br>$${analysis.baselineAvgCost.toFixed(4)}</span>`;
                
                document.getElementById('scmsBar').style.height = `${scmsHeight}%`;
                document.getElementById('scmsBar').innerHTML = `<span>SCMS<br>$${analysis.scmsAvgCost.toFixed(4)}</span>`;
            }
            
            // Update pattern list
            if (patterns && patterns.length > 0) {
                document.getElementById('patternROI').textContent = patterns.length;
                
                const patternsList = document.getElementById('patternsList');
                patternsList.innerHTML = patterns.slice(0, 5).map(pattern => `
                    <div class="pattern-item">
                        <div class="pattern-name">${pattern.name}</div>
                        <div class="pattern-stats">
                            <span>Type: ${pattern.type}</span>
                            <span>Uses: ${pattern.uses || 1}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function updateEnhancedEconomics(data) {
            const { analysis, sessions } = data;
            
            // Calculate cumulative ROI
            const scmsSessions = sessions.filter(s => s.type === 'scms');
            const totalScmsCost = scmsSessions.reduce((sum, s) => sum + (s.totalCost || 0), 0);
            const totalSavings = analysis.savings * scmsSessions.length || 0;
            const roiPercent = totalScmsCost > 0 ? ((totalSavings / totalScmsCost) * 100) : 0;
            
            document.getElementById('cumulativeROI').textContent = `${roiPercent.toFixed(1)}%`;
            document.getElementById('roiBreakdown').textContent = 
                `Saved: $${totalSavings.toFixed(3)} | Invested: $${totalScmsCost.toFixed(3)}`;
            
            // Economic Signature Classification with Badge Styling
            const savingsPercent = analysis.savingsPercent || 0;
            let signature = 'Baseline';
            let description = 'Not enough data to classify system efficiency';
            let badgeClass = 'signature-baseline';
            
            if (savingsPercent >= 60) {
                signature = 'üöÄ Exponential Returns';
                description = 'Peak efficiency: Validated patterns compound. 3x margin transformation achieved.';
                badgeClass = 'signature-exponential';
            } else if (savingsPercent >= 45) {
                signature = 'üìà Compound Benefits';
                description = 'Strong optimization: Pattern library maturing. Margin transformation accelerating.';
                badgeClass = 'signature-compound';
            } else if (savingsPercent >= 30) {
                signature = '‚úÖ Initial Savings';
                description = 'Conservative target achieved. Pattern validation in progress.';
                badgeClass = 'signature-initial';
            } else if (savingsPercent >= 15) {
                signature = '‚ö†Ô∏è Early Stage';
                description = 'Below conservative target. Need more pattern reuse and validation commits.';
                badgeClass = 'signature-early';
            } else if (savingsPercent > 0) {
                signature = 'üîç Baseline +';
                description = 'Marginal improvement detected. System not yet optimized.';
                badgeClass = 'signature-baseline-plus';
            }
            
            const badgeElement = document.getElementById('economicSignatureBadge');
            badgeElement.textContent = signature;
            badgeElement.className = 'signature-badge ' + badgeClass;
            document.getElementById('signatureDescription').textContent = description;
            
            // Platform Economics (based on per-user annual savings)
            const avgSavingsPerSession = analysis.savings || 0;
            // Assume 200 sessions/year per heavy user
            const annualSavingsPerUser = avgSavingsPerSession * 200;
            const savings10K = annualSavingsPerUser * 10000;
            const savings100K = annualSavingsPerUser * 100000;
            
            document.getElementById('platformSavings').textContent = `$${(annualSavingsPerUser * 1000).toLocaleString()}`;
            document.getElementById('platform10K').textContent = `$${(savings10K / 1000000).toFixed(2)}M`;
            document.getElementById('platform100K').textContent = `$${(savings100K / 1000000).toFixed(1)}M`;
        }
        
        // Watch for dashboard data file changes (reload every 5 seconds)
        function startDataWatcher() {
            dataWatcher = setInterval(async () => {
                if (monitorActive) {
                    await loadDashboardData();
                }
            }, 5000); // Reload every 5 seconds when monitor active
        }
        
        function stopDataWatcher() {
            if (dataWatcher) {
                clearInterval(dataWatcher);
                dataWatcher = null;
            }
        }
        
        // OLD: Listen for data updates
        document.addEventListener('scms-data-updated', (event) => {
            const { currentSession, analysis, patterns } = event.detail;
            
            // Update current session metrics
            if (currentSession) {
                document.getElementById('sessionCost').textContent = `$${currentSession.totalCost.toFixed(4)}`;
                document.getElementById('retrievalRatio').textContent = `${currentSession.retrievalRatio.toFixed(1)}%`;
                document.getElementById('efficiencyProgress').style.width = `${Math.min(currentSession.retrievalRatio, 100)}%`;
            }
            
            // Update comparative analysis
            if (analysis) {
                const savingsPercent = Math.max(0, analysis.savingsPercent);
                document.getElementById('savingsPercent').textContent = `${savingsPercent.toFixed(1)}%`;
                document.getElementById('savingsProgress').style.width = `${Math.min(savingsPercent / 45 * 100, 100)}%`;
                
                // Update comparison chart
                const maxCost = Math.max(analysis.scmsAvgCost, analysis.baselineAvgCost);
                if (maxCost > 0) {
                    const baselineHeight = (analysis.baselineAvgCost / maxCost) * 100;
                    const scmsHeight = (analysis.scmsAvgCost / maxCost) * 100;
                    
                    document.getElementById('baselineBar').style.height = `${baselineHeight}%`;
                    document.getElementById('baselineBar').innerHTML = `<span>Baseline<br>$${analysis.baselineAvgCost.toFixed(4)}</span>`;
                    
                    document.getElementById('scmsBar').style.height = `${scmsHeight}%`;
                    document.getElementById('scmsBar').innerHTML = `<span>SCMS<br>$${analysis.scmsAvgCost.toFixed(4)}</span>`;
                }
            }
            
            // Update pattern ROI
            if (patterns && patterns.length > 0) {
                document.getElementById('patternROI').textContent = patterns.length;
                
                const patternsList = document.getElementById('patternsList');
                patternsList.innerHTML = patterns.slice(0, 5).map(pattern => `
                    <div class="pattern-item">
                        <div class="pattern-name">${pattern.name}</div>
                        <div class="pattern-stats">
                            <span>Uses: ${pattern.uses}</span>
                            <span>Savings: $${pattern.totalSavings.toFixed(4)}</span>
                            <span>ROI: $${pattern.avgSavingsPerUse.toFixed(4)}/use</span>
                        </div>
                    </div>
                `).join('');
            }
        });
        
        // Simulate some demo interactions for testing
        function simulateDemo() {
            // Simulate SCMS session
            window.scmsTracker.startSession('scms');
            
            // Simulate pattern usage
            setTimeout(() => {
                window.scmsLogPattern('Error Handling Pattern', 250);
            }, 1000);
            
            setTimeout(() => {
                window.scmsLogPattern('API Integration Pattern', 300);
            }, 2000);
            
            setTimeout(() => {
                window.scmsLogGeneration(400, 300, 100);
            }, 3000);
            
            setTimeout(() => {
                window.scmsTracker.endSession();
                
                // Start baseline session
                window.scmsTracker.startSession('baseline');
                
                setTimeout(() => {
                    window.scmsLogGeneration(600, 800, 200);
                }, 1000);
                
                setTimeout(() => {
                    window.scmsLogGeneration(550, 750, 150);
                }, 2000);
                
                setTimeout(() => {
                    window.scmsTracker.endSession();
                }, 3000);
            }, 4000);
        }
        
        // AUTO-STAMP: Detect improper shutdown and auto-close abandoned sessions
        async function checkAbandonedSession() {
            const abandonedSession = localStorage.getItem('scms_current_session');
            
            if (abandonedSession && isElectron) {
                const session = JSON.parse(abandonedSession);
                const now = new Date();
                const started = new Date(session.timestamp);
                const hoursSince = (now - started) / (1000 * 60 * 60);
                
                // If session started more than 1 hour ago, it was likely abandoned
                if (hoursSince > 1) {
                    console.warn('[dashboard] ‚ö†Ô∏è Abandoned session detected:', session);
                    
                    // Auto-close with shutdown stamp
                    const shutdownStamp = {
                        action: 'session_auto_closed',
                        timestamp: session.timestamp, // Use original start time
                        endedAt: new Date().toISOString(),
                        userInitiated: false,
                        reason: 'improper_shutdown',
                        note: 'Session was not manually ended - auto-closed on next dashboard open'
                    };
                    
                    await window.electronAPI.stopCheckpointMonitor(shutdownStamp);
                    localStorage.removeItem('scms_current_session');
                    
                    // Show warning to user
                    alert(
                        `‚ö†Ô∏è Previous session was not properly closed\n` +
                        `Started: ${new Date(session.timestamp).toLocaleString()}\n` +
                        `Auto-closed: ${new Date().toLocaleString()}\n\n` +
                        `Data has been saved. Remember to click "End Session" before closing the dashboard.`
                    );
                }
            }
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAbandonedSession();
            await loadDashboardData();
            
            // Start health monitoring with auto-refresh
            startHealthRefresh();
            
            // Restore startup prompt state
            restoreStartupPromptState();
            
            console.log('[dashboard] Initialization complete - Economics and Health tabs ready');
        });
        
        // AUTO-STAMP: Mark session for potential recovery on page unload
        window.addEventListener('beforeunload', () => {
            const currentSession = localStorage.getItem('scms_current_session');
            if (currentSession && monitorActive) {
                console.warn('[dashboard] ‚ö†Ô∏è Dashboard closing with active session');
                // Session will be detected as abandoned on next load
            }
        });
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            if (isElectron) {
                // Load initial data
                await loadDashboardData();
                
                // Start data watcher
                startDataWatcher();
                
                // Listen for checkpoint monitor logs
                window.electronAPI.onCheckpointMonitorLog((log) => {
                    console.log('[monitor]', log);
                    
                    // If checkpoint processed, reload data
                    if (log.includes('Dashboard updated')) {
                        loadDashboardData();
                    }
                });
                
                // Listen for monitor stopped
                window.electronAPI.onCheckpointMonitorStopped(() => {
                    monitorActive = false;
                    updateSessionDisplay('Monitor Stopped', 'Checkpoint monitor stopped unexpectedly');
                });
                
                console.log('[dashboard] Initialized in Electron mode');
            } else {
                console.warn('[dashboard] Not running in Electron - limited functionality');
            }
        });
    </script>
</body>
</html>
